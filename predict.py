import pickle
import nltk
import numpy as np
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.preprocessing import LabelEncoder
from pickle_vect import deserialize_DecisionTree, tfidf_Deserialize, deserialize_dict_vect, deserialize_encode_state
from nltk.tokenize.treebank import TreebankWordDetokenizer
from nltk import word_tokenize
import scipy.sparse

from tokenize_json import tfidf_vectorize

def parse_pronto(title,description,feature,build):

    text_vectorizer = tfidf_Deserialize()
    porter = nltk.PorterStemmer()
    twd = TreebankWordDetokenizer()
    tokens = word_tokenize(title + ' ' + description)
    stemmed_tokens = [porter.stem(t) for t in tokens]
    text = TreebankWordDetokenizer.detokenize(twd, stemmed_tokens)
    text_to_matrix = text_vectorizer.transform([text])


    feature_vectorize = deserialize_dict_vect()
    # print(feature_vectorize)
    feature_dict = {'build' : build , 'feature' : feature}
    # print(feature_dict)
    feature_matrix = feature_vectorize.transform(feature_dict)
    # print("Printing the feature_matrix ", feature_matrix)

    data_matrix = scipy.sparse.hstack((feature_matrix, text_to_matrix))
    # print("Printing the data_matrix",data_matrix)
    return data_matrix



def decode_state(label):

    with open('label_encode.out', 'rb') as f:
        encoding = pickle.load(f)

    if hasattr(encoding, 'classes_'):
        unseen_labels = set(label) - set(encoding.classes_)
        if unseen_labels:
            encoding.classes_ = np.append(encoding.classes_, list(unseen_labels))
    else:
        encoding.fit(label)

    
    label = np.array(label).ravel()
  
    label_decoder = encoding.inverse_transform(label)
    return label_decoder[0]



def predict(data_matrix):
    clf = deserialize_DecisionTree()
    
    label_result = clf.predict(data_matrix)
    # print("Printing the label_result", label_result)
    return decode_state(label_result) 

if __name__ == "__main__":

    title = "[FDD][SBTS22R1][Airscale+Airscale][4G-5G][FRPD][FHS][MDCD][NSA][FID:4038] Shared RMs raised alarm \"Radio master conflict\" (FID:4038) on LTE side and stuck in initializing state without any alarm on 5G side after RM reset/ RM Power Off/On"
    description = "*** DEFAULT TEMPLATE for 2G-3G-4G-5G-SRAN-FDD-TDD-DCM-Micro-Controller common template v1.4.0 (02.07.2021) â€“ PLEASE FILL IT IN BEFORE CREATING A PR AND DO NOT CHANGE / REMOVE ANY SECTION OF THIS TEMPLATE ***\r\n\r\n[1. Detail Test Steps:]\r\n\r\n5G and LTE on air\r\nShared RM Reset / RM Power Off/On \r\n\r\n[2. Expected Result:]\r\n\r\nAfter Shared RM Reset / Power Off/On 5G and LTE should be on air without any unexpected alarms\r\n\r\n[3. Actual Result:]\r\n\r\nAfter Shared RM Reset / Power Off/On  shared RMs raised alarm \"Radio master conflict\" (FID:4038) on LTE side and in 5G side shared RMs are stuck in initializing state without any alarm\r\nAll cells are faulty without any alarm on both 5G and LTE\r\n\r\n[4. Tester analysis:]\r\n\r\nLTE Syslogs called: SYSLOG_24_LTE.zip\r\n\r\n097477 22.09 11:54:48.911 [192.168.255.129] bc FCT-1011-3-FRI 2021-09-22T08:54:48.845163Z 4AC1-FRI INF/FRI/FRI, [AlarmAssembler] Set alarm : /MRBTS-1/RAT-1/LTS-1/LNBTS_L-1/ALARM-17, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7650\r\n097493 22.09 11:54:48.921 [192.168.255.129] c1 FCT-1011-3-FRI 2021-09-22T08:54:48.847575Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Reported alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112\r\n097494 22.09 11:54:48.921 [192.168.255.129] c2 FCT-1011-3-FRI 2021-09-22T08:54:48.847739Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Activated alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112, Invisible : 0\r\n097512 22.09 11:54:48.931 [192.168.255.129] cb FCT-1011-3-FRI 2021-09-22T08:54:48.848250Z 4AC1-FRI INF/FRI/FRI, [CategoryAlarmFromAlarmConverter] Reported alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112\r\n108190 22.09 11:55:02.333 [192.168.255.129] f4 FCT-1011-3-FRI 2021-09-22T08:55:02.318919Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Deactivated alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112, Invisible : 0\r\n108203 22.09 11:55:02.343 [192.168.255.129] fd FCT-1011-3-FRI 2021-09-22T08:55:02.319141Z 4AC1-FRI INF/FRI/FRI, [CategoryAlarmFromAlarmConverter] Clear alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112\r\n320154 22.09 11:58:49.032 [192.168.255.129] 54 FCT-1011-3-FRI 2021-09-22T08:58:48.707032Z 4AC1-FRI INF/FRI/FRI, [AlarmAssembler] Set alarm : /MRBTS-1/RAT-1/LTS-1/LNBTS_L-1/ALARM-18, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7650\r\n320161 22.09 11:58:49.042 [192.168.255.129] 59 FCT-1011-3-FRI 2021-09-22T08:58:48.709485Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Reported alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-17, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112\r\n320162 22.09 11:58:49.042 [192.168.255.129] 5a FCT-1011-3-FRI 2021-09-22T08:58:48.709645Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Activated alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-17, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112, Invisible : 0\r\n320184 22.09 11:58:49.053 [192.168.255.129] 63 FCT-1011-3-FRI 2021-09-22T08:58:48.710279Z 4AC1-FRI INF/FRI/FRI, [CategoryAlarmFromAlarmConverter] Reported alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-17, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112\r\n\r\n\r\n050877 22.09 11:53:25.432 [192.168.255.129] d6 FCT-1011-3-FRI 2021-09-22T08:53:25.199323Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Adjust alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-5, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/CABINET_L-1/SMOD_L-1, FaultId: 4592, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/CABINET_R-1/SMOD_R-1, Severity: 0, AlarmNumber: 7115\r\n097493 22.09 11:54:48.921 [192.168.255.129] c1 FCT-1011-3-FRI 2021-09-22T08:54:48.847575Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Reported alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112\r\n097494 22.09 11:54:48.921 [192.168.255.129] c2 FCT-1011-3-FRI 2021-09-22T08:54:48.847739Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Activated alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112, Invisible : 0\r\n108189 22.09 11:55:02.333 [192.168.255.129] f3 FCT-1011-3-FRI 2021-09-22T08:55:02.318775Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Clearing alarm: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2 (Fault: 4038)\r\n108190 22.09 11:55:02.333 [192.168.255.129] f4 FCT-1011-3-FRI 2021-09-22T08:55:02.318919Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Deactivated alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-16, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112, Invisible : 0\r\n140969 22.09 11:55:41.901 [192.168.255.129] e0 FCT-1011-3-FRI 2021-09-22T08:55:41.308024Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Adjust alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-5, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/CABINET_L-1/SMOD_L-1, FaultId: 4592, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/CABINET_R-1/SMOD_R-1, Severity: 0, AlarmNumber: 7115\r\n175540 22.09 11:55:57.952 [192.168.255.129] 9b FCT-1011-3-FRI 2021-09-22T08:55:57.347394Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Adjust alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-5, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/CABINET_L-1/SMOD_L-1, FaultId: 4592, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/CABINET_R-1/SMOD_R-1, Severity: 0, AlarmNumber: 7115\r\n178045 22.09 11:56:00.563 [192.168.255.129] a5 FCT-1011-3-FRI 2021-09-22T08:56:00.340031Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Adjust alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-5, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/CABINET_L-1/SMOD_L-1, FaultId: 4592, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/CABINET_R-1/SMOD_R-1, Severity: 0, AlarmNumber: 7115\r\n183638 22.09 11:56:04.707 [192.168.255.129] 2e FCT-1011-3-FRI 2021-09-22T08:56:04.344977Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Adjust alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-5, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/CABINET_L-1/SMOD_L-1, FaultId: 4592, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/CABINET_R-1/SMOD_R-1, Severity: 0, AlarmNumber: 7115\r\n271605 22.09 11:57:26.078 [192.168.255.129] cd FCT-1011-3-FRI 2021-09-22T08:57:25.590722Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Adjust alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-5, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/CABINET_L-1/SMOD_L-1, FaultId: 4592, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/CABINET_R-1/SMOD_R-1, Severity: 0, AlarmNumber: 7115\r\n320161 22.09 11:58:49.042 [192.168.255.129] 59 FCT-1011-3-FRI 2021-09-22T08:58:48.709485Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Reported alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-17, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112\r\n320162 22.09 11:58:49.042 [192.168.255.129] 5a FCT-1011-3-FRI 2021-09-22T08:58:48.709645Z 4AC1-FRI INF/FRI/FRI, [AlarmReporter] Activated alarm : /MRBTS-1/RAT-1/FRI-1/ALARM-17, Reported By: /MRBTS-1/RAT-1/BTS_L-1/EQM_L-1/RMOD_L-2, FaultId: 4038, AlarmingDN: /MRBTS-1/RAT-1/RUNTIME_VIEW-1/MRBTS_R-1/EQM_R-1/APEQM_R-1/RMOD_R-2, Severity: 0, AlarmNumber: 7112, Invisible : 0\r\n\r\n[5. Pronto Creator Interface (PCI) information:]\r\n\r\nPCI executed for Problem Report (22.09.2021, 10:23:54 UTC):\r\nPCI ID: PCI_20210922_120903_000\r\nMLoGIC model version: mlogic_1.1.0_20210415\r\nAccess PCI to check AIPA PG, SIMSBot, MLoGIC results: https://rep-portal.wroclaw.nsn-rdnet.net/pci/?pci_id=PCI_20210922_120903_000\r\n\r\n[6. Log(s) file name containing a fault: (clear indication (exact file name) and timestamp where fault can be found in attached logs):]\r\n\r\n\\\\eseefsn50.emea.nsn-net.net\\rotta4internal\\LTE_2\\atasala\\RadioMasterConflict\r\n\r\n[7. Test-Line Reference/used HW/configuration/tools/SW version:]\r\n\r\nNSA NR 10 MHz DSS Phase2  + LTE 10 MHz DSS Phase 2\r\n[4G]: ASIB+ABIA (left side in AMIA)\r\n[5G]:    ASIK+3xABIL+ MDCD(FHS) (right side in AMIA) + 3 x AEQE \r\nShared RF: 1xFRPD (n28)\r\nDedicated RF [LTE]: 1xFXED (b3)\r\nDedicated RF [NR]: 3 x AEQE (n78)\r\n\r\n5G SW: SBTS22R1_ENB_0000_000088_000000\r\nLTE SW: SBTS22R1_ENB_0000_000088_000000\r\n\r\n[8. Used Flags: (list here used R&D flags):]\r\n\r\nNR:\r\n\r\n# ERadDomain_Ccs\r\n0x1003F=1           # AaSysLogInputLevel [0/6=disabled; 1=DBG; 2=INF; 3=WRN; 4=ERR; 5=VIP]\r\n0x10040=1           # AaSysLogOutputLevel 0x2\r\n0x10041=5           # AaSysLogOutputMode [0=none; 1=all; 2=udp; 3=sic; 4=standard output; 5=local; 6=remote]\r\n0x10042=0xC0A8FF7E # AaSysLogUdpAddress  192.168.255.126\r\n0x10043=0xC738     # AaSysLogUdpPort     51000\r\n\r\n\r\n\r\n#DSS Ph2\r\n0x59007c=1 #1586 C enabled\r\n0x580158=0 #NR flag - 5GC00742 disabled\r\n0x590072=1 #NR flag CPRT activate debug trace\r\n0x5801a6=1 #Nr flag , R&D param: rdEnableFDMPdschDmrs,to improve Tput on DL NR by 5% only in the case of 2x2 MIMO + 256 QAM.1 - activated,0 - deactivated\r\n\r\n#4G\r\n\r\n0x67000A=0 #LTE flag for CRM - no UL,0: UL DSS enabled (default),1: UL DSS disabled for UL\r\n0x1e0203=0 #LTE flag for MACPS,0:Dynamic DSS enabled (default)1:Dynamic DSS disabled for UL\r\n0x67000B=0 #LTE flag for UL.0: UL PRB allocation is dynamically changed according to client(LTE/5G) UL load measurements (default).1: Static 50/50 UL PRB pattern is used.\r\n\r\n# CCS-specific flags\r\n0x1003F=1\r\n0x10040=1\r\n0x10041=5\r\n\r\n# BBC debugging flags\r\n275=1\r\n0x19011E=1\r\n\r\n#enable BBC Verbose logs\r\n0x19011E=1\r\n\r\n#PR556244 This flag will make NRTS print content of files exchanged between OAM and CPlane into syslog.\r\n0x600006 = 1\r\n\r\n0x1A0020=0x1 (#Enable R&DPorts and SSH)\r\n\r\n0x45005A=1\t#Enabling ADMIN developer account\r\n\r\n\r\n#For RUMAG debug logs:\r\n245=2 #RPMAG prints\r\n250=6000000 #SOAP Trace\r\n252=2 #apw prints\r\n0x1003F = 1 #Prints stored to RAM(pm)\r\n0x10040 = 1 #Prints forwarded to output devices\r\n\r\n\r\nLTE:\r\n\r\n#Log enabling related\r\n0x1003f=1 #ERadCcs_AaSysLogInputLevel - Severity changed from DEBUG to INF\r\n0x10040=1 #ERadCcs_AaSysLogOutputLevel - Severity changed from DEBUG to INFO\r\n0x10041=5 #ERadCcs_AaSysLogInputLevel - Severity changed from DEBUG to INF\r\n0x10042 = 0xC0A8ff82  #for VMs with debug interface 192.168.255.130; for IP ending in .126 we have 7E instead of 82\r\n0x10043 = 0xc738\r\n#ETH Security disabled\r\n0x1A0020=1\r\n#IM Gateway needed for IM Commander, enables port 12345; can be removed for CommonTrunk and FL18SP releases\r\n0x3A0001 = 1\r\n#Enabling ADMIN developer account:\r\n0x45005A = 1\r\n#BBC debug\r\n275=1\r\n#Maximum number of resets allowed within one hour\r\n0x310001 = 300\r\n#FSP recovery resets allowed within one hour\r\n0x500002 = 30\r\n#LTE recovery resets allowed within one hour\r\n0x500001 = 30\r\n245=2\r\n\r\n#RF logs on BTS logs\r\n0x200A6=1\r\n\r\n\r\n[9. Test Scenario History of Execution: (what was changed since it was tested successfully for the last time):]\r\n\r\nWas Test Scenario passing before? ( YES | NO | New scenario ) YES\r\n\r\nWhat was the last SW version Test Scenario was passing? ( SW load | New scenario ) SW load: SBTS22R1_ENB_9999_210806_000005\r\n\r\nWere there any differences between test-lines since last time Test Scenario was passing?  ( YES, explanation | NO | New test-line ) NO\r\n\r\nWere there any changes in Test Scenario since last run it passed? ( YES, explanation | NO | New scenario ) NO \r\n\r\n[10. Test Case Reference: (QC, RP or UTE link):]\r\n\r\ntds://rfs_bts_iv.mn_bb.qc-prod.ext.net.nokia.com/qcbin/TestLabModule-000000003649890581?EntityType=ITestInstance&EntityID=640471\r\n\r\n*** END OF DEFAULT TEMPLATE ***"
    feature = "5GC001702-C"
    build = "SBTS22R1_ENB_0000_000088_000000"

    parse = parse_pronto(title,description,feature,build)
    
    prediction = predict(parse)

    print("Prediction: " , prediction)

